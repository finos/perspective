import e from"https://cdn.jsdelivr.net/npm/@finos/perspective@3.0.0/dist/cdn/perspective.js";import{manaStyleListener as t}from"./mana_cost_utils.js";import"./upload_dialog.js";const a=await e.worker(),i=async function(){const e=await fetch("./layouts.json");return await e.json()}(),s=async function(){const e=await fetch("https://api.scryfall.com/symbology");return(await e.json()).data}();class n extends HTMLElement{async get_all_cards(){if(!this._table){this.querySelector("#message").textContent="Downloading all cards...";let e="./all_identifiers.arrow";const t=await fetch(e),i=await t.arrayBuffer();this._table=await a.table(i),this.querySelector("#message").textContent=""}return this._table}async create_deck(e){const t=await this.get_all_cards(),i=await t.view({filter:[["name","in",e]]}),s=await i.to_arrow(),n=a.table(s);return i.delete(),await n}async on_load_deck({detail:{name:e,filter:t}}){this._dialog.parentElement.removeChild(this._dialog),this._dialog=void 0,workspace.tables.has(e)||workspace.addTable(e,await this.create_deck(t));const a=structuredClone(await i);a.viewers.viewer1.title=e,a.viewers.viewer1.table=e,a.viewers.viewer2.table=e,a.viewers.viewer3.table=e,workspace.restore(a)}async on_new_view(e){const a=e.detail.widget.viewer,i=await a.getPlugin("Datagrid");i.regular_table.addStyleListener(t.bind(i.regular_table,await s,a))}on_open_dialog(){this._dialog?(this._dialog.parentElement.removeChild(this._dialog),this._dialog=void 0):(this._dialog=document.createElement("upload-dialog"),document.body.appendChild(this._dialog),this._dialog.addEventListener("upload-event",this.on_load_deck.bind(this)))}connectedCallback(){this.innerHTML='\n            <div id="app">\n                <div id="header">\n                    <a href="https://perspective.finos.org">\n                        <img\n                            height="12"\n                            src="https://raw.githubusercontent.com/finos/perspective/master/docs/static/svg/perspective-logo-light.svg" />\n                    </a>\n                    <label>Magic: the Gathering Deck Demo</label>\n                    <button>Load Deck</button>\n                    <span id="message"></span>\n                </div>\n                <perspective-workspace theme="Pro Light" id="workspace"></perspective-workspace>\n            </div>\n        ';const e=this.querySelector("perspective-workspace");e.addEventListener("workspace-new-view",this.on_new_view),e.addTable("all_cards",this.get_all_cards()),e.addViewer({table:"all_cards"}),this.querySelector("button").addEventListener("click",this.on_open_dialog.bind(this))}}window.customElements.define("magic-app",n);